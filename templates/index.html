<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Marz Node UI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body data-theme="neon">
<div class="page-root">

    <!-- Ù†ÙˆØ§Ø± Ø¨Ø§Ù„Ø§ÛŒ ØµÙØ­Ù‡ -->
    <header class="top-bar">
        <div class="top-left">
            <div class="logo-title">Marz Node UI</div>
            <div class="subtitle">
                Ù…Ø¯ÛŒØ±ÛŒØª Ù†ÙˆØ¯Ù‡Ø§ Ùˆ Ù‡Ø§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø±Ø²Ù†Ø´ÛŒÙ† Ø¨Ø§ Ù‚Ø§Ø¨Ù„ÛŒØª Soft Delete Ù†ÙˆØ¯Ù‡Ø§
            </div>
            <div class="server-url">
                Server: <a href="{{ server_url }}" target="_blank">{{ server_url }}</a>
            </div>
        </div>

        <div class="top-right">
            <div class="top-notice">
                Theme (ÙÙ‚Ø· Ø¯Ø± Ø§ÛŒÙ† Ù…Ø±ÙˆØ±Ú¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯)
            </div>
            <div class="theme-switcher">
                <button class="theme-btn" data-theme="default">Default</button>
                <button class="theme-btn" data-theme="purple">Purple</button>
                <button class="theme-btn" data-theme="neon">Neon</button>
                <button class="theme-btn" data-theme="glass">Glass</button>
                <button class="theme-btn" data-theme="amoled">AMOLED</button>
                <button class="theme-btn" data-theme="minimal">Minimal</button>
            </div>
            <div class="soft-delete-hint">
                ğŸ›¡ï¸ Soft Delete Ù†ÙˆØ¯Ù‡Ø§ (Ù‡Ø§Ø³Øªâ€ŒÙ‡Ø§ Ùˆ Ø§ÛŒÙ†Ø¨Ø§Ù†Ø¯Ù‡Ø§ Ø­Ø°Ù Ù†Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯)
            </div>
        </div>
    </header>

    <!-- Ø±Ø¯ÛŒÙ Ø§ØµÙ„ÛŒ: Ù‡Ø§Ø³Øªâ€ŒÙ‡Ø§ + Ù†ÙˆØ¯Ù‡Ø§ -->
    <main class="main-grid">

        <!-- Ù‡Ø§Ø³Øªâ€ŒÙ‡Ø§ -->
        <section class="card hosts-card">
            <div class="card-header">
                <div class="card-title">Ù‡Ø§Ø³Øªâ€ŒÙ‡Ø§ (Hosts)</div>
                <div class="card-subtitle">
                    ÙˆÛŒØ±Ø§ÛŒØ´ / Ø­Ø°Ù Ù‡Ø§Ø³Øªâ€ŒÙ‡Ø§ Ø¨Ø¯ÙˆÙ† Ø¯Ø³Øªâ€ŒØ²Ø¯Ù† Ø¨Ù‡ Ù†ÙˆØ¯Ù‡Ø§ Ùˆ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
                </div>
            </div>

            {% if hosts_error %}
                <div class="error-box">{{ hosts_error }}</div>
            {% endif %}

            <div class="table-wrapper">
                <table class="table">
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>Ø¢Ø¯Ø±Ø³</th>
                        <th>Ù¾ÙˆØ±Øª</th>
                        <th>ÙˆØ²Ù†</th>
                        <th>ÙˆÛŒØ±Ø§ÛŒØ´ / Ø­Ø°Ù</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for h in hosts %}
                        <tr>
                            <td>{{ h.id }}</td>
                            <td>{{ h.address }}</td>
                            <td>{{ h.port }}</td>
                            <td>
                                {% if h.weight is defined %}
                                    {{ h.weight }}
                                {% elif h.usage_ratio is defined %}
                                    {{ h.usage_ratio }}
                                {% else %}
                                    None
                                {% endif %}
                            </td>
                            <td>
                                <form method="post" action="/hosts/{{ h.id }}/update" class="inline-form">
                                    <input class="input input-small" type="text" name="address" value="{{ h.address }}">
                                    <input class="input input-small" type="number" name="port" value="{{ h.port }}">
                                    <input class="input input-small" type="number" name="weight"
                                           value="{% if h.weight is defined %}{{ h.weight }}{% elif h.usage_ratio is defined %}{{ h.usage_ratio }}{% else %}1{% endif %}">
                                    <button class="btn btn-primary btn-compact" type="submit">Ø°Ø®ÛŒØ±Ù‡</button>
                                </form>

                                <form method="post" action="/hosts/{{ h.id }}/delete" class="inline-form">
                                    <button class="btn btn-danger btn-compact" type="submit">Ø­Ø°Ù</button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Ù†ÙˆØ¯Ù‡Ø§ -->
        <section class="card nodes-card">
            <div class="card-header">
                <div class="card-title">Ù†ÙˆØ¯Ù‡Ø§ (Nodes)</div>
                <div class="card-subtitle">
                    Ø­Ø§Ù„Øª Soft Delete Ù†ÙˆØ¯Ù‡Ø§ (Ù‡Ø§Ø³Øªâ€ŒÙ‡Ø§ Ùˆ Ø§ÛŒÙ†Ø¨Ø§Ù†Ø¯Ù‡Ø§ Ø­Ø°Ù Ù†Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯)
                </div>
            </div>

            {% if nodes_error %}
                <div class="error-box">{{ nodes_error }}</div>
            {% endif %}

            <div class="table-wrapper">
                <table class="table">
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>Ø¢Ø¯Ø±Ø³</th>
                        <th>Ù¾ÙˆØ±Øª</th>
                        <th>Ù†Ø§Ù…</th>
                        <th>Soft Delete / ÙˆÛŒØ±Ø§ÛŒØ´</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for n in nodes %}
                        <tr>
                            <td>{{ n.id }}</td>
                            <td>{{ n.address }}</td>
                            <td>{{ n.port }}</td>
                            <td>{{ n.name }}</td>
                            <td>
                                <form method="post" action="/nodes/{{ n.id }}/soft-delete" class="inline-form">
                                    <button class="btn btn-danger btn-compact" type="submit">Soft Delete</button>
                                </form>

                                <a class="btn btn-primary btn-compact"
                                   href="/?node_id={{ n.id }}">ÙˆÛŒØ±Ø§ÛŒØ´</a>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Ø§ÛŒØ¬Ø§Ø¯ Ù†ÙˆØ¯ Ø¬Ø¯ÛŒØ¯ -->
            <div class="new-node-block">
                <div class="card-subtitle">Ø§ÛŒØ¬Ø§Ø¯ Ù†ÙˆØ¯ Ø¬Ø¯ÛŒØ¯</div>
                <p class="hint-text">
                    Ø¨Ø¹Ø¯ Ø§Ø² Ø³Ø§Ø®Øª Ù†ÙˆØ¯ØŒ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ù…Ø±Ø²Ù†Ø´ÛŒÙ† Ø±Ø§ Ø±ÙˆÛŒ Ø³Ø±ÙˆØ± Ù…Ù‚ØµØ¯ Ù†ØµØ¨ Ú©Ù† ØªØ§ Ù†ÙˆØ¯ Ø¢Ù†Ù„Ø§ÛŒÙ† Ø´ÙˆØ¯.
                </p>
                <form method="post" action="/nodes/create" class="new-node-form">
                    <input class="input" type="text" name="name" placeholder="Ù†Ø§Ù… Ù†ÙˆØ¯">
                    <input class="input" type="text" name="address" placeholder="Ø¢Ø¯Ø±Ø³ (IP ÛŒØ§ Ø¯Ø§Ù…Ù†Ù‡)">
                    <input class="input" type="number" name="port" placeholder="Ù¾ÙˆØ±Øª">
                    <button class="btn btn-primary" type="submit">Ø§ÛŒØ¬Ø§Ø¯ Ù†ÙˆØ¯</button>
                </form>
            </div>
        </section>

    </main>

    <!-- Ø±Ø¯ÛŒÙ Ø¯ÙˆÙ…: Ø¬Ø²ÛŒÛŒØ§Øª Ù†ÙˆØ¯ + SSH / Xray -->
    <section class="bottom-grid">
        <!-- Ø¬Ø²ÛŒÛŒØ§Øª Ù†ÙˆØ¯ Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ -->
        <section class="card node-details-card">
            <div class="card-header">
                <div class="card-title">Ø¬Ø²ÛŒÛŒØ§Øª Ù†ÙˆØ¯ Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡</div>
                <div class="card-subtitle">
                    Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø²ÛŒÛŒØ§ØªØŒ Ø±ÙˆÛŒ Â«ÙˆÛŒØ±Ø§ÛŒØ´Â» ÛŒÚ©ÛŒ Ø§Ø² Ù†ÙˆØ¯Ù‡Ø§ Ø¯Ø± Ø¬Ø¯ÙˆÙ„ Ø¨Ø§Ù„Ø§ Ú©Ù„ÛŒÚ© Ú©Ù†.
                </div>
            </div>

            <div class="node-details-content">
                {% if selected_node %}
                    <pre class="node-details-pre">
ID: {{ selected_node.id }}
Ù†Ø§Ù…: {{ selected_node.name }}
Ø¢Ø¯Ø±Ø³: {{ selected_node.address }}
Ù¾ÙˆØ±Øª: {{ selected_node.port }}

{{ selected_node | tojson(indent=2) }}
                    </pre>
                {% else %}
                    <div class="hint-text">
                        Ù‡Ù†ÙˆØ² Ù†ÙˆØ¯ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.
                    </div>
                {% endif %}
            </div>
        </section>

        <!-- SSH / Xray / JSON panel -->
        <section class="card ssh-card">
            <div class="card-header">
                <div class="card-title">Xray Ø±ÙˆÛŒ Ù†ÙˆØ¯ (SSH)</div>
                <div class="card-subtitle">
                    Ø¨Ø¯ÙˆÙ† Ù†ÛŒØ§Ø² Ø¨Ù‡ ÙˆØ±ÙˆØ¯ Ù…Ø³ØªÙ‚ÛŒÙ… Ø±ÙˆÛŒ Ø³Ø±ÙˆØ±ØŒ ÙØ§ÛŒÙ„ <code>config.json</code> Ø±Ø§ Ø§Ø¯ÛŒØª Ú©Ù† Ùˆ Ø¨Ø¹Ø¯
                    Ú©Ø§Ù†ØªÛŒÙ†Ø± Xray Ø±Ø§ Ø¨Ø§ <code>docker compose</code> Ø±ÛŒâ€ŒØ§Ø³ØªØ§Ø±Øª Ú©Ù†.
                    Ù…Ø³ÛŒØ±Ù‡Ø§ Ø·Ø¨Ù‚ <b>Ù†Ø§Ù… Ù†ÙˆØ¯ (Ø¨Ø±Ú†Ø³Ø¨ Ù¾ÙˆØ´Ù‡)</b> Ø¨Ù‡â€ŒØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø³Ø§Ø®ØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.
                </div>
            </div>

            <form method="post" action="/ssh/save-config" class="ssh-form">
                {% if selected_node %}
                    <input type="hidden" name="node_id" value="{{ selected_node.id }}">
                {% endif %}

                <div class="ssh-grid">
                    <div class="ssh-col">
                        <label class="field-label">IP / Host</label>
                        <input class="input" type="text" name="ssh_host"
                               value="{{ ssh_info.ssh_host }}" placeholder="IP / Host">

                        <label class="field-label">SSH Port</label>
                        <input class="input" type="number" name="ssh_port"
                               value="{{ ssh_info.ssh_port }}" placeholder="22">

                        <label class="field-label">User</label>
                        <input class="input" type="text" name="ssh_user"
                               value="{{ ssh_info.ssh_user }}" placeholder="root">
                    </div>

                    <div class="ssh-col">
                        <label class="field-label">Password</label>
                        <input class="input" type="password" name="ssh_password"
                               value="{{ ssh_info.ssh_password }}" placeholder="*******">

                        <label class="field-label">Ù†Ø§Ù… Ù†ÙˆØ¯ (Ø¨Ø±Ú†Ø³Ø¨ Ù¾ÙˆØ´Ù‡ØŒ Ù…Ø«Ù„ fr ÛŒØ§ TR)</label>
                        <input class="input" type="text" name="ssh_node_label"
                               value="{{ ssh_info.ssh_node_label }}" placeholder="Ù…Ø«Ù„Ø§Ù‹ TR">
                    </div>
                </div>

                <div class="ssh-derived-info">
                    <div>ğŸ“‚ Ù…Ø³ÛŒØ± Ù†ÙˆØ¯:
                        <code>
                            {% if ssh_info.ssh_node_label %}
                                /opt/marznode/{{ ssh_info.ssh_node_label }}
                            {% else %}
                                /opt/marznode/&lt;label&gt;
                            {% endif %}
                        </code>
                    </div>
                    <div>ğŸ§¾ ÙØ§ÛŒÙ„ ØªÙ†Ø¸ÛŒÙ…Ø§Øª: <code>xray/config.json</code></div>
                    <div>ğŸ³ docker compose:
                        <code>docker compose -f docker-compose.yml down && docker compose -f docker-compose.yml up -d</code>
                    </div>
                </div>

                <!-- JSON panel -->
                <div class="json-panel">
                    <div class="json-panel-header">
                        <span>Xray config.json</span>
                        <span class="json-panel-hint">
                            Ø§ÛŒÙ†Ø¬Ø§ JSON Ø±Ø§ Ù…Ø±ØªØ¨ Ùˆ Ú†Ù†Ø¯ Ø®Ø·ÛŒ Ù…ÛŒâ€ŒØ¨ÛŒÙ†ÛŒØ› Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒ Ù…Ø³ØªÙ‚ÛŒÙ… Ø§Ø¯ÛŒØª Ú©Ù†ÛŒ.
                        </span>
                    </div>
                    <textarea class="json-textarea" name="ssh_config_json"
                              spellcheck="false">{{ ssh_json|e }}</textarea>
                </div>

                {% if ssh_error %}
                    <div class="error-box">{{ ssh_error }}</div>
                {% endif %}

                <div class="actions-row">
                    <button class="btn btn-secondary"
                            type="submit"
                            formaction="/ssh/load-config">
                        Ø®ÙˆØ§Ù†Ø¯Ù† config.json Ø§Ø² Ù†ÙˆØ¯
                    </button>

                    <button class="btn btn-danger" type="submit">
                        Ø°Ø®ÛŒØ±Ù‡ config.json Ø±ÙˆÛŒ Ù†ÙˆØ¯ Ùˆ Ø§Ø¬Ø±Ø§ÛŒ docker compose
                    </button>

                    <button class="btn btn-warning"
                            type="submit"
                            formaction="/ssh/node-off">
                        Ø®Ø§Ù…ÙˆØ´ Ù…ÙˆÙ‚Øª Ù†ÙˆØ¯ (OFF)
                    </button>

                    <button class="btn btn-success"
                            type="submit"
                            formaction="/ssh/node-on">
                        Ø±ÙˆØ´Ù† Ú©Ø±Ø¯Ù† Ù†ÙˆØ¯ (ON)
                    </button>
                </div>

                <!-- âœ… NEW hidden inputs -->
                <input type="hidden" name="op_node_label" id="op_node_label" value="">
                <input type="hidden" name="op_xray_version" id="op_xray_version" value="">

                <!-- âœ… NEW buttons -->
                <div class="actions-row" style="margin-top:0.9rem;">
                    <button class="btn btn-secondary"
                            type="button"
                            onclick="submitWithPrompt('/ssh/backup-node', 'Ø§Ø³Ù… Ù†ÙˆØ¯ Ø¨Ø±Ø§ÛŒ Ø¨Ú©Ø§Ù¾ØŸ Ù…Ø«Ù„Ø§ FR', 'op_node_label')">
                        Ø¨Ú©Ø§Ù¾ Ù†ÙˆØ¯ (Backup Node)
                    </button>

                    <button class="btn btn-warning"
                            type="button"
                            onclick="submitWithPrompt('/ssh/restore-node', 'Ø§Ø³Ù… Ù†ÙˆØ¯ Ø¨Ø±Ø§ÛŒ Ø±ÛŒØ³ØªÙˆØ±ØŸ Ù…Ø«Ù„Ø§ FR', 'op_node_label')">
                        Ø±ÛŒØ³ØªÙˆØ± Ø¨Ú©Ø§Ù¾ Ù†ÙˆØ¯ (Restore Backup)
                    </button>

                    <button class="btn btn-primary"
                            type="button"
                            onclick="submitWithTwoPrompts('/ssh/change-core', 'Ø§Ø³Ù… Ù†ÙˆØ¯ØŸ Ù…Ø«Ù„Ø§ FR', 'op_node_label', 'ÙˆØ±Ú˜Ù† XrayØŸ Ù…Ø«Ù„Ø§ 1.8.8', 'op_xray_version')">
                        ØªØºÛŒÛŒØ± Ù‡Ø³ØªÙ‡ Ù†ÙˆØ¯ / ÙˆØ±Ú˜Ù† Xray
                    </button>
                </div>

                <div class="small-hint">
                    Ø®Ø§Ù…ÙˆØ´/Ø±ÙˆØ´Ù† Ú©Ø±Ø¯Ù† Ù†ÙˆØ¯ ÙÙ‚Ø· Ø±ÙˆÛŒ Ú©Ø§Ù†ØªÛŒÙ†Ø± Xray Ù‡Ù…Ø§Ù† VPS Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯Ø›
                    Ù‡Ø§Ø³Øªâ€ŒÙ‡Ø§ Ùˆ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¯Ø± Ù¾Ù†Ù„ Ù…Ø±Ø²Ù†Ø´ÛŒÙ† Ø¯Ø³Øªâ€ŒÙ†Ø®ÙˆØ±Ø¯Ù‡ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ù†Ø¯ ğŸ’™
                </div>
            </form>
        </section>
    </section>

    <footer class="footer">
        ğŸ’™ Marz Node UI â€“ Soft Delete Nodes, Keep Hosts Alive â€“ Built for personal use
    </footer>
</div>

<script>
    // ========== Theme handling ==========
    (function () {
        const saved = localStorage.getItem("marz_theme");
        const body = document.body;
        if (saved) {
            body.setAttribute("data-theme", saved);
        }

        const buttons = document.querySelectorAll(".theme-btn");
        buttons.forEach(btn => {
            btn.addEventListener("click", () => {
                const theme = btn.getAttribute("data-theme");
                body.setAttribute("data-theme", theme);
                localStorage.setItem("marz_theme", theme);
            });
        });
    })();

    // âœ… NEW helpers
    function submitWithPrompt(action, text, hiddenId) {
        const v = prompt(text || "");
        if (!v) return;
        document.getElementById(hiddenId).value = v.trim();

        const form = document.querySelector(".ssh-form");
        form.action = action;
        form.method = "post";
        form.submit();
    }

    function submitWithTwoPrompts(action, text1, hidden1, text2, hidden2) {
        const v1 = prompt(text1 || "");
        if (!v1) return;
        const v2 = prompt(text2 || "");
        if (!v2) return;

        document.getElementById(hidden1).value = v1.trim();
        document.getElementById(hidden2).value = v2.trim();

        const form = document.querySelector(".ssh-form");
        form.action = action;
        form.method = "post";
        form.submit();
    }
</script>

</body>
</html>
